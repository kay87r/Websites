<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Bill Generator</title>
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Noto+Serif:ital,wght@0,400..700;1,400..700&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'serif': ['Noto Serif', 'serif'],
                        'mono': ['Roboto Mono', 'monospace'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the crushed templates */
        .crushed-paper {
            background-size: 6px 6px;
        }
        /* Hide number input spinners */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] {
            -moz-appearance: textfield;
        }
        .appearance-none {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-4xl w-full border border-gray-200">
        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-8 tracking-tight">
            Restaurant Bill Generator
        </h1>

        <!-- Restaurant and Bill Details Section -->
        <div class="mb-8 p-6 bg-green-50 rounded-lg border border-green-200 shadow-inner">
            <h2 class="text-2xl font-bold text-green-800 mb-5">Restaurant & Bill Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="restaurantName" class="block text-sm font-medium text-gray-700 mb-1">Restaurant Name</label>
                    <input type="text" id="restaurantName" value="My Awesome Restaurant" class="w-full p-3 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 transition duration-200" />
                </div>
                <div class="col-span-full md:col-span-2">
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <input type="text" id="address" value="123 Main St, Anytown, USA" class="w-full p-3 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 transition duration-200" />
                </div>
                <div>
                    <label for="tableNo" class="block text-sm font-medium text-gray-700 mb-1">Table No.</label>
                    <input type="text" id="tableNo" class="w-full p-3 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 transition duration-200" />
                </div>
                <div>
                    <label for="invoiceNumber" class="block text-sm font-medium text-gray-700 mb-1">Invoice No.</label>
                    <input type="text" id="invoiceNumber" class="w-full p-3 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 transition duration-200" />
                </div>
                <div>
                    <label for="vatNumber" class="block text-sm font-medium text-gray-700 mb-1">VAT No.</label>
                    <input type="text" id="vatNumber" class="w-full p-3 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 transition duration-200" />
                </div>
                <div class="col-span-full md:col-span-1">
                    <label for="billDateTime" class="block text-sm font-medium text-gray-700 mb-1">Bill Date & Time</label>
                    <input type="datetime-local" id="billDateTime" class="w-full p-3 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 transition duration-200" />
                </div>
                <div>
                    <label for="paymentMethod" class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                    <select id="paymentMethod" class="w-full p-3 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 transition duration-200 bg-white">
                        <option value="Cash">Cash</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                        <option value="Online Payment">Online Payment</option>
                        <option value="UPI">UPI</option>
                    </select>
                </div>
                <div>
                    <label for="currency" class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                    <select id="currency" class="w-full p-3 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 transition duration-200 bg-white"></select>
                </div>
            </div>
        </div>

        <!-- Input Section -->
        <div class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200 shadow-inner">
            <h2 class="text-2xl font-bold text-blue-800 mb-5">Add New Item</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="col-span-2">
                    <label for="itemName" class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                    <input type="text" id="itemName" placeholder="e.g., Chicken Biryani" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200" />
                </div>
                <div>
                    <label for="itemQuantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                    <input type="number" id="itemQuantity" value="1" min="1" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200" />
                </div>
                <div>
                    <label for="itemPrice" class="block text-sm font-medium text-gray-700 mb-1">Price (per unit)</label>
                    <input type="number" id="itemPrice" placeholder="e.g., 12.50" step="0.01" min="0" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200" />
                </div>
                <button id="addItemBtn" class="col-span-full md:col-span-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-0.5">
                    Add Item
                </button>
            </div>
        </div>

        <!-- Bill Details Section (for adding/removing items) -->
        <div class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200 shadow-inner">
            <h2 class="text-2xl font-bold text-gray-800 mb-5">Bill Items Management</h2>
            <div id="itemListContainer" class="overflow-x-auto mb-6">
                <!-- Item list table will be dynamically inserted here -->
            </div>
            <p id="noItemsMessage" class="text-center text-gray-500 py-8">No items added yet. Add items above to see the bill.</p>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-center space-x-4 mb-8">
            <button id="clearAllBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-0.5">
                Clear All
            </button>
            <div class="relative">
                <label for="taxRate" class="sr-only">Tax Rate</label>
                <input type="number" id="taxRate" value="10" min="0" step="0.1" class="w-24 p-3 border border-gray-300 rounded-md text-center focus:ring-blue-500 focus:border-blue-500 transition duration-200 appearance-none" aria-label="Set Tax Rate Percentage" />
                <span class="absolute inset-y-0 right-3 flex items-center text-gray-500 pointer-events-none">%</span>
            </div>
            <button id="generatePdfBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-0.5">
                Save as PDF
            </button>
        </div>

        <!-- Bill Preview Template Selector -->
        <div class="mb-8 p-6 bg-purple-50 rounded-lg border border-purple-200 shadow-inner">
            <h2 class="text-2xl font-bold text-purple-800 mb-4">Choose Bill Preview Template</h2>
            <select id="billTemplate" class="w-full p-3 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 transition duration-200 bg-white">
                <option value="modern">Modern Template</option>
                <option value="classic">Classic Template</option>
                <option value="minimal">Minimal Template</option>
                <option value="crushed">Crushed Paper Template (Random)</option>
                <option value="crushed-A">Crushed Paper Template (A)</option>
                <option value="crushed-B">Crushed Paper Template (B)</option>
                <option value="crushed-C">Crushed Paper Template (C)</option>
                <option value="crushed-D">Crushed Paper Template (D)</option>
                <option value="crushed-E">Crushed Paper Template (E)</option>
                <option value="receipt">Receipt Style Template</option>
                <option value="bold">Bold & Clean Template</option>
                <option value="retro-dot-matrix">Retro Dot Matrix Template</option>
                <option value="clean-boxed">Clean Boxed Template</option>
                <option value="elegant-line">Elegant Line Template</option>
                <option value="dark-accent">Dark Accent Template</option>
                <option value="simple-grid">Simple Grid Template</option>
                <option value="modern-compact">Modern Compact Template</option>
                <option value="elegant-minimal">Elegant Minimal Template</option>
                <option value="dark-professional">Dark Professional Template</option>
                <option value="colorful-gradient">Colorful Gradient Template</option>
                <option value="corporate-clean">Corporate Clean Template</option>
                <option value="rustic-charm">Rustic Charm Template</option>
            </select>
        </div>

        <!-- Bill Preview Section -->
        <div id="billPreviewContainer">
            <!-- The bill preview will be rendered here -->
        </div>
    </div>

    <!-- HTML2Canvas and JsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Global State Variables ---
            let items = [];
            let restaurantName = 'My Awesome Restaurant';
            let address = '123 Main St, Anytown, USA';
            let tableNo = '';
            let invoiceNumber = '';
            let vatNumber = '';
            const now = new Date();
            let billDateTime = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            let paymentMethod = 'Cash';
            let currency = 'USD';
            let taxRate = 10;
            let billTemplate = 'modern';
            const currencies = [
                { code: 'USD', symbol: '$' },
                { code: 'EUR', symbol: '€' },
                { code: 'GBP', symbol: '£' },
                { code: 'JPY', symbol: '¥' },
                { code: 'CAD', symbol: 'C$' },
                { code: 'AUD', symbol: 'A$' },
                { code: 'CHF', symbol: 'CHF' },
                { code: 'CNY', symbol: '¥' },
                { code: 'INR', symbol: '₹' },
                { code: 'AED', symbol: 'د.إ' },
                { code: 'SAR', symbol: 'ر.س' },
                { code: 'JOD', symbol: 'JD' },
                { code: 'MXN', symbol: '$' },
                { code: 'BRL', symbol: 'R$' },
            ];
            let pdfLoading = false;

            // --- DOM Element References ---
            const restaurantNameInput = document.getElementById('restaurantName');
            const addressInput = document.getElementById('address');
            const tableNoInput = document.getElementById('tableNo');
            const invoiceNumberInput = document.getElementById('invoiceNumber');
            const vatNumberInput = document.getElementById('vatNumber');
            const billDateTimeInput = document.getElementById('billDateTime');
            const paymentMethodSelect = document.getElementById('paymentMethod');
            const currencySelect = document.getElementById('currency');
            const itemNameInput = document.getElementById('itemName');
            const itemQuantityInput = document.getElementById('itemQuantity');
            const itemPriceInput = document.getElementById('itemPrice');
            const addItemBtn = document.getElementById('addItemBtn');
            const itemListContainer = document.getElementById('itemListContainer');
            const noItemsMessage = document.getElementById('noItemsMessage');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const taxRateInput = document.getElementById('taxRate');
            const generatePdfBtn = document.getElementById('generatePdfBtn');
            const billTemplateSelect = document.getElementById('billTemplate');
            const billPreviewContainer = document.getElementById('billPreviewContainer');

            // --- Event Listeners for DOM Elements ---
            restaurantNameInput.addEventListener('input', (e) => {
                restaurantName = e.target.value;
                renderBillPreview();
            });
            addressInput.addEventListener('input', (e) => {
                address = e.target.value;
                renderBillPreview();
            });
            tableNoInput.addEventListener('input', (e) => {
                tableNo = e.target.value;
                renderBillPreview();
            });
            invoiceNumberInput.addEventListener('input', (e) => {
                invoiceNumber = e.target.value;
                renderBillPreview();
            });
            vatNumberInput.addEventListener('input', (e) => {
                vatNumber = e.target.value;
                renderBillPreview();
            });
            billDateTimeInput.addEventListener('change', (e) => {
                billDateTime = e.target.value;
                renderBillPreview();
            });
            paymentMethodSelect.addEventListener('change', (e) => {
                paymentMethod = e.target.value;
                renderBillPreview();
            });
            currencySelect.addEventListener('change', (e) => {
                currency = e.target.value;
                renderBillPreview();
            });
            taxRateInput.addEventListener('input', (e) => {
                taxRate = parseFloat(e.target.value) || 0;
                renderBillPreview();
            });
            billTemplateSelect.addEventListener('change', (e) => {
                billTemplate = e.target.value;
                renderBillPreview();
            });
            addItemBtn.addEventListener('click', handleAddItem);
            clearAllBtn.addEventListener('click', handleClearAll);
            generatePdfBtn.addEventListener('click', handleGeneratePdf);

            // --- Template Styles and Logic (Same as React Component) ---
            const templateStyles = {
                modern: {
                    headerClasses: "text-xl font-bold text-center text-gray-900 mb-4 border-b border-dashed border-gray-400 pb-2",
                    restaurantInfoClasses: "text-center mb-4 text-xs",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-500 text-xs mt-4",
                    previewContainerClasses: "p-4 bg-white shadow-2xl border border-gray-200 max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-gray-100",
                    tableRowBorderClass: "border-b border-dashed border-gray-300",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: false,
                },
                classic: {
                    headerClasses: "text-xl font-serif text-center text-gray-900 mb-4 border-b border-dashed border-gray-400 pb-2",
                    restaurantInfoClasses: "text-center mb-4 font-serif text-xs",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-600 text-xs italic mt-4",
                    previewContainerClasses: "p-4 bg-white shadow-2xl border border-gray-200 max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-gray-100",
                    tableRowBorderClass: "border-b border-dashed border-gray-300",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-serif",
                    showItemBorders: false,
                    shuffleBillInfo: true,
                    billInfoInFooter: false,
                },
                minimal: {
                    headerClasses: "text-lg font-semibold text-center text-gray-800 mb-3 pb-1 border-b border-dashed border-gray-300",
                    restaurantInfoClasses: "text-center mb-3 text-xs",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-500 text-xs mt-3",
                    previewContainerClasses: "p-4 bg-white shadow-2xl border border-gray-200 max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-transparent",
                    tableRowBorderClass: "border-b border-dashed border-gray-200",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: false,
                },
                'crushed': {
                    headerClasses: "text-xl font-bold text-center text-gray-900 mb-4 border-b-2 border-gray-400 pb-2",
                    restaurantInfoClasses: "text-center mb-4 text-sm",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-700 text-xs mt-4 font-semibold",
                    previewContainerClasses: "p-4 shadow-2xl border border-gray-300 transition-all duration-300 ease-in-out max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-gray-100",
                    tableRowBorderClass: "border-b border-dashed border-gray-300",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: false,
                },
                'crushed-A': {
                    headerClasses: "text-xl font-bold text-center text-gray-900 mb-4 border-b-2 border-gray-400 pb-2",
                    restaurantInfoClasses: "text-center mb-4 text-sm",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-700 text-xs mt-4 font-semibold",
                    previewContainerClasses: "p-4 shadow-2xl border border-gray-300 transition-all duration-300 ease-in-out max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-gray-100",
                    tableRowBorderClass: "border-b border-dashed border-gray-300",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: false,
                },
                'crushed-B': {
                    headerClasses: "text-xl font-bold text-center text-gray-900 mb-4 border-b-2 border-gray-400 pb-2",
                    restaurantInfoClasses: "text-center mb-4 text-sm",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-700 text-xs mt-4 font-semibold",
                    previewContainerClasses: "p-4 shadow-2xl border border-gray-300 transition-all duration-300 ease-in-out max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-gray-100",
                    tableRowBorderClass: "border-b border-dashed border-gray-300",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: false,
                },
                'crushed-C': {
                    headerClasses: "text-xl font-bold text-center text-gray-900 mb-4 border-b-2 border-gray-400 pb-2",
                    restaurantInfoClasses: "text-center mb-4 text-sm",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-700 text-xs mt-4 font-semibold",
                    previewContainerClasses: "p-4 shadow-2xl border border-gray-300 transition-all duration-300 ease-in-out max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-gray-100",
                    tableRowBorderClass: "border-b border-dashed border-gray-300",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: false,
                },
                'crushed-D': {
                    headerClasses: "text-xl font-bold text-center text-gray-900 mb-4 border-b-2 border-gray-400 pb-2",
                    restaurantInfoClasses: "text-center mb-4 text-sm",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-700 text-xs mt-4 font-semibold",
                    previewContainerClasses: "p-4 shadow-2xl border border-gray-300 transition-all duration-300 ease-in-out max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-gray-100",
                    tableRowBorderClass: "border-b border-dashed border-gray-300",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: false,
                },
                'crushed-E': {
                    headerClasses: "text-xl font-bold text-center text-gray-900 mb-4 border-b-2 border-gray-400 pb-2",
                    restaurantInfoClasses: "text-center mb-4 text-sm",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-700 text-xs mt-4 font-semibold",
                    previewContainerClasses: "p-4 shadow-2xl border border-gray-300 transition-all duration-300 ease-in-out max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-gray-100",
                    tableRowBorderClass: "border-b border-dashed border-gray-300",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: false,
                },
                receipt: {
                    headerClasses: "text-lg font-bold text-center mb-2 pb-1 border-b border-dashed border-gray-400",
                    restaurantInfoClasses: "text-center mb-2 text-xs",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-xs mt-2",
                    previewContainerClasses: "p-3 bg-white shadow-md border border-gray-200 max-w-[14rem] mx-auto font-mono text-xs",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-transparent",
                    tableRowBorderClass: "border-b border-dashed border-gray-300",
                    tableCellPaddingClass: "py-0.5 px-0.5",
                    fontFamilyClass: "font-mono",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: false,
                },
                bold: {
                    headerClasses: "text-2xl font-extrabold text-center text-gray-900 mb-6 border-b-4 border-blue-600 pb-3",
                    restaurantInfoClasses: "text-center mb-6 text-base font-semibold",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-700 text-base font-bold mt-8",
                    previewContainerClasses: "p-4 bg-white shadow-2xl border border-gray-200 max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-blue-600 text-white",
                    tableRowBorderClass: "border-b border-gray-200",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: true,
                    billInfoInFooter: false,
                },
                'retro-dot-matrix': {
                    headerClasses: "text-xl font-bold text-center text-gray-800 mb-4 border-b border-dashed border-gray-500 pb-2",
                    restaurantInfoClasses: "text-center mb-4 text-xs tracking-wide",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-600 text-xs mt-4 tracking-wide",
                    previewContainerClasses: "p-4 bg-white shadow-md border border-gray-300 max-w-sm mx-auto font-mono text-xs bg-gradient-to-b from-gray-50 to-gray-100",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-gray-200",
                    tableRowBorderClass: "border-b border-dashed border-gray-300",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-mono",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: false,
                },
                'clean-boxed': {
                    headerClasses: "text-xl font-bold text-center text-gray-900 mb-4 pb-2 border-b border-gray-300",
                    restaurantInfoClasses: "text-center mb-4 p-2 border border-gray-200 rounded-md bg-gray-50 text-xs",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-600 text-xs mt-4",
                    previewContainerClasses: "p-4 bg-white rounded-lg shadow-lg border border-gray-200 max-w-sm mx-auto",
                    tableBorderClass: "border border-gray-300",
                    tableHeaderBgClass: "bg-blue-50",
                    tableRowBorderClass: "border-b border-gray-200",
                    tableCellPaddingClass: "py-2 px-3",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: false,
                },
                'elegant-line': {
                    headerClasses: "text-2xl font-light text-center text-gray-800 mb-6 border-b border-gray-300 pb-3 tracking-wide",
                    restaurantInfoClasses: "text-center mb-6 text-xs italic",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-500 text-xs mt-6",
                    previewContainerClasses: "p-5 bg-white rounded-lg shadow-xl border border-gray-100 max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-transparent",
                    tableRowBorderClass: "border-b border-gray-200",
                    tableCellPaddingClass: "py-1.5 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: false,
                },
                'dark-accent': {
                    headerClasses: "text-xl font-bold text-center text-white bg-gray-800 py-2 rounded-t-lg -mx-4 -mt-4 mb-4",
                    restaurantInfoClasses: "text-center mb-4 text-xs text-gray-700",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-600 text-xs mt-4",
                    previewContainerClasses: "p-4 bg-gray-50 rounded-lg shadow-xl border border-gray-300 max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-gray-700 text-white",
                    tableRowBorderClass: "border-b border-gray-200",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: true,
                },
                'simple-grid': {
                    headerClasses: "text-xl font-bold text-center text-gray-900 mb-4 pb-2",
                    restaurantInfoClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-500 text-xs mt-4",
                    previewContainerClasses: "p-4 bg-white rounded-lg shadow-md border border-gray-100 max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-gray-50",
                    tableRowBorderClass: "border-b border-gray-100",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: false,
                },
                'modern-compact': {
                    headerClasses: "text-lg font-bold text-center text-gray-900 mb-3 border-b border-dashed border-gray-400 pb-1.5",
                    restaurantInfoClasses: "text-center mb-3 text-xs leading-tight",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-3 border-b border-dashed border-gray-400 pb-1.5 text-center",
                    thankYouClasses: "text-center text-gray-500 text-xs mt-3",
                    previewContainerClasses: "p-3 bg-white shadow-xl border border-gray-200 max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-gray-50",
                    tableRowBorderClass: "border-b border-dashed border-gray-200",
                    tableCellPaddingClass: "py-0.5 px-1",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: false,
                },
                'elegant-minimal': {
                    headerClasses: "text-xl font-light text-center text-gray-700 mb-5 border-b border-gray-200 pb-2.5 tracking-wide",
                    restaurantInfoClasses: "text-center mb-5 text-xs italic text-gray-500",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-400 text-xs mt-5",
                    previewContainerClasses: "p-5 bg-white rounded-lg shadow-xl border border-gray-100 max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-white",
                    tableRowBorderClass: "border-b border-gray-100",
                    tableCellPaddingClass: "py-1.5 px-2",
                    fontFamilyClass: "font-serif",
                    showItemBorders: false,
                    shuffleBillInfo: true,
                    billInfoInFooter: false,
                },
                'dark-professional': {
                    headerClasses: "text-xl font-bold text-center text-white bg-gray-900 py-3 rounded-t-lg -mx-4 -mt-4 mb-4",
                    restaurantInfoClasses: "text-center mb-4 text-xs text-gray-200",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-400 text-xs mt-4",
                    previewContainerClasses: "p-4 bg-gray-800 rounded-lg shadow-xl border border-gray-700 max-w-sm mx-auto text-white",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-gray-700 text-white",
                    tableRowBorderClass: "border-b border-gray-600",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: true,
                },
                'colorful-gradient': {
                    headerClasses: "text-2xl font-extrabold text-center text-white mb-6 py-3 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500",
                    restaurantInfoClasses: "text-center mb-6 text-sm text-gray-700",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-600 text-sm mt-8",
                    previewContainerClasses: "p-4 bg-white rounded-xl shadow-2xl border border-gray-200 max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-blue-100",
                    tableRowBorderClass: "border-b border-gray-200",
                    tableCellPaddingClass: "py-1.5 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    swapItemQty: true,
                    shuffleBillInfo: true,
                    billInfoInFooter: true,
                },
                'corporate-clean': {
                    headerClasses: "text-xl font-bold text-center text-gray-900 mb-4 pb-2 border-b-2 border-gray-300",
                    restaurantInfoClasses: "text-center mb-4 text-xs",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-600 text-xs mt-4",
                    previewContainerClasses: "p-4 bg-white rounded-lg shadow-lg border border-gray-200 max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-gray-100",
                    tableRowBorderClass: "border-b border-dashed border-gray-200",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-inter",
                    showItemBorders: false,
                    shuffleBillInfo: false,
                    billInfoInFooter: true,
                },
                'rustic-charm': {
                    headerClasses: "text-xl font-bold text-center text-gray-800 mb-4 pb-2 border-b border-gray-400",
                    restaurantInfoClasses: "text-center mb-4 text-sm font-serif italic",
                    billInfoGridClasses: "grid grid-cols-1 gap-y-0.5 text-gray-700 text-xs mb-4 border-b border-dashed border-gray-400 pb-2 text-center",
                    thankYouClasses: "text-center text-gray-700 text-xs mt-4",
                    previewContainerClasses: "p-5 bg-yellow-50 rounded-lg shadow-xl border border-yellow-200 max-w-sm mx-auto",
                    tableBorderClass: "border-none",
                    tableHeaderBgClass: "bg-yellow-100",
                    tableRowBorderClass: "border-b border-dashed border-yellow-300",
                    tableCellPaddingClass: "py-1 px-2",
                    fontFamilyClass: "font-serif",
                    showItemBorders: false,
                    shuffleBillInfo: true,
                    billInfoInFooter: false,
                },
            };

            const getCurrencySymbol = (code) => {
                const found = currencies.find(c => c.code === code);
                return found ? found.symbol : '';
            };

            // --- Core Functions ---
            function renderApp() {
                // Render currency options
                currencySelect.innerHTML = currencies.map(curr => `<option value="${curr.code}">${curr.code} (${curr.symbol})</option>`).join('');
                currencySelect.value = currency;
                billDateTimeInput.value = billDateTime;
                taxRateInput.value = taxRate;
                restaurantNameInput.value = restaurantName;
                addressInput.value = address;
                renderItemListTable();
                renderBillPreview();
            }

            function renderItemListTable() {
                const tableHeader = `
                    <table class="min-w-full bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200">
                        <thead class="${templateStyles[billTemplate].tableHeaderBgClass} border-b border-gray-200">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">Item</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">Qty</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">Price</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">Total</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr class="${templateStyles[billTemplate].tableRowBorderClass} last:border-b-0">
                                    <td class="py-3 px-4 text-gray-800">${item.name}</td>
                                    <td class="py-3 px-4 text-gray-800">${item.quantity}</td>
                                    <td class="py-3 px-4 text-gray-800">${getCurrencySymbol(currency)}${(item.price).toFixed(2)}</td>
                                    <td class="py-3 px-4 text-gray-800">${getCurrencySymbol(currency)}${(item.total).toFixed(2)}</td>
                                    <td class="py-3 px-4">
                                        <button data-id="${item.id}" class="remove-item-btn text-red-500 hover:text-red-700 transition duration-200" title="Remove Item">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm2 4a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                if (items.length > 0) {
                    itemListContainer.innerHTML = tableHeader;
                    noItemsMessage.classList.add('hidden');
                } else {
                    itemListContainer.innerHTML = '';
                    noItemsMessage.classList.remove('hidden');
                }
                document.querySelectorAll('.remove-item-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.dataset.id, 10);
                        handleRemoveItem(id);
                    });
                });
            }

            function renderBillPreview() {
                const currentStyle = templateStyles[billTemplate] || templateStyles.modern;
                const subtotal = items.reduce((sum, item) => sum + (item.total), 0);
                const taxAmount = (subtotal * taxRate) / 100;
                const total = subtotal + taxAmount;
                const currentCurrencySymbol = getCurrencySymbol(currency);

                let formattedBillDateTime;
                try {
                    const dateObj = new Date(billDateTime);
                    if (isNaN(dateObj.getTime())) {
                        formattedBillDateTime = 'Invalid Date';
                    } else {
                        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
                        formattedBillDateTime = dateObj.toLocaleString('en-US', options);
                    }
                } catch (e) {
                    formattedBillDateTime = 'Error Formatting Date';
                    console.error("Date formatting error:", e);
                }

                const billInfoItems = [
                    { label: 'Invoice No', value: invoiceNumber || 'N/A' },
                    { label: 'Date', value: formattedBillDateTime },
                    { label: 'Table No', value: tableNo || 'N/A' },
                    { label: 'Payment Method', value: paymentMethod },
                ];

                const displayedBillInfo = currentStyle.shuffleBillInfo
                    ? [...billInfoItems].sort(() => Math.random() - 0.5)
                    : billInfoItems;

                const billInfoContent = `
                    <div class="${currentStyle.billInfoGridClasses}">
                        ${displayedBillInfo.map(info => `
                            <div><strong>${info.label}:</strong> ${info.value}</div>
                        `).join('')}
                    </div>
                `;

                let billContent = '';
                if (items.length === 0) {
                    billContent = `<p class="text-center text-gray-500 py-4 text-xs">No items in the bill to preview.</p>`;
                } else {
                    const itemHeader = currentStyle.swapItemQty ? `
                        <span class="w-1/6 text-center">Qty</span>
                        <span class="w-1/2 text-left">Item</span>
                        <span class="w-1/6 text-right">Price</span>
                        <span class="w-1/6 text-right">Total</span>
                    ` : `
                        <span class="w-1/2 text-left">Item</span>
                        <span class="w-1/6 text-center">Qty</span>
                        <span class="w-1/6 text-right">Price</span>
                        <span class="w-1/6 text-right">Total</span>
                    `;

                    const itemRows = items.map(item => {
                        const rowContent = currentStyle.swapItemQty ? `
                            <span class="w-1/6 text-center">${item.quantity}</span>
                            <span class="w-1/2 text-left">${item.name}</span>
                            <span class="w-1/6 text-right">${currentCurrencySymbol}${item.price.toFixed(2)}</span>
                            <span class="w-1/6 text-right">${currentCurrencySymbol}${(item.total).toFixed(2)}</span>
                        ` : `
                            <span class="w-1/2 text-left">${item.name}</span>
                            <span class="w-1/6 text-center">${item.quantity}</span>
                            <span class="w-1/6 text-right">${currentCurrencySymbol}${item.price.toFixed(2)}</span>
                            <span class="w-1/6 text-right">${currentCurrencySymbol}${(item.total).toFixed(2)}</span>
                        `;
                        return `<div class="flex justify-between py-0.5 ${currentStyle.showItemBorders ? 'border-b border-dashed border-gray-200' : ''} last:border-b-0">${rowContent}</div>`;
                    }).join('');

                    billContent = `
                        <div class="mb-4 text-xs text-gray-800">
                            <div class="flex justify-between font-semibold pb-1 mb-1 ${currentStyle.tableHeaderBgClass} ${currentStyle.showItemBorders ? 'border-b border-dashed border-gray-300' : ''}">
                                ${itemHeader}
                            </div>
                            ${itemRows}
                        </div>
                    `;
                }

                let previewContainerStyle = '';
                if (billTemplate.startsWith('crushed')) {
                    const randomRotation = (Math.random() * 4 - 2).toFixed(2);
                    const randomTranslateX = (Math.random() * 8 - 4).toFixed(2);
                    const randomTranslateY = (Math.random() * 8 - 4).toFixed(2);
                    const randomScale = (1 + Math.random() * 0.02 - 0.01).toFixed(3);
                    const randomShadowOffset = (Math.random() * 6 + 1).toFixed(0);
                    const randomShadowBlur = (Math.random() * 10 + 3).toFixed(0);
                    const randomBorderRadius = (Math.random() * 8 + 3).toFixed(0);
                    const randomHue = Math.floor(Math.random() * 30) + 30;
                    const randomSaturation = Math.floor(Math.random() * 20) + 80;
                    const randomLightness = Math.floor(Math.random() * 10) + 90;

                    previewContainerStyle = `
                        transform: rotate(${randomRotation}deg) translateX(${randomTranslateX}px) translateY(${randomTranslateY}px) scale(${randomScale});
                        box-shadow: ${randomShadowOffset}px ${randomShadowOffset}px ${randomShadowBlur}px rgba(0,0,0,0.3);
                        border-radius: ${randomBorderRadius}px;
                        background-color: hsl(${randomHue}, ${randomSaturation}%, ${randomLightness}%);
                        background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M9 10L7 10V8L9 8V10ZM11 0L9 0V2L11 2V0ZM13 4L11 4V6L13 6V4ZM11 8L9 8V10L11 10V8ZM9 2L7 2V4L9 4V2ZM13 0L11 0V2L13 2V0ZM7 6L5 6V8L7 8V6ZM5 0L3 0V2L5 2V0ZM7 4L5 4V6L7 6V4ZM3 8L1 8V10L3 10V8ZM1 2L-1 2V4L1 4V2ZM3 6L1 6V8L3 8V6ZM-1 0L-3 0V2L-1 2V0ZM5 10L3 10V8L5 8V10ZM3 4L1 4V6L3 6V4ZM-1 4L-3 4V6L-1 6V4ZM1 0L-1 0V2L1 2V0Z'/%3E%3C/g%3E%3C/svg%3E");
                    `;
                }

                const billHtml = `
                    <div class="${currentStyle.previewContainerClasses} ${currentStyle.fontFamilyClass} ${billTemplate.startsWith('crushed') ? 'crushed-paper' : ''}" style="${previewContainerStyle}">
                        <h2 class="${currentStyle.headerClasses}"></h2>
                        <div class="${currentStyle.restaurantInfoClasses}">
                            <h3 class="text-lg font-bold text-gray-800">${restaurantName}</h3>
                            <p class="text-gray-600">${address}</p>
                            ${vatNumber ? `<p class="text-gray-600">VAT No: ${vatNumber}</p>` : ''}
                        </div>
                        ${!currentStyle.billInfoInFooter ? billInfoContent : ''}
                        ${billContent}
                        <div class="flex flex-col items-end space-y-1 text-xs font-semibold text-gray-800 border-t border-dashed border-gray-400 pt-2 mt-2">
                            <div class="flex justify-between w-full max-w-[12rem]">
                                <span>Subtotal:</span>
                                <span>${currentCurrencySymbol}${subtotal.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between w-full max-w-[12rem]">
                                <span>Tax (${taxRate}%):</span>
                                <span>${currentCurrencySymbol}${taxAmount.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between w-full max-w-[12rem] text-sm font-bold text-blue-700 pt-1">
                                <span>Grand Total:</span>
                                <span>${currentCurrencySymbol}${total.toFixed(2)}</span>
                            </div>
                        </div>
                        ${currentStyle.billInfoInFooter ? `<div class="mt-4 pt-2 border-t border-dashed border-gray-400">${billInfoContent}</div>` : ''}
                        <p class="${currentStyle.thankYouClasses}">Thank you for your business!</p>
                    </div>
                `;

                billPreviewContainer.innerHTML = billHtml;
            }

            function handleAddItem() {
                const itemName = itemNameInput.value.trim();
                const itemQuantity = parseInt(itemQuantityInput.value, 10);
                const itemPrice = parseFloat(itemPriceInput.value);

                if (itemName === '' || isNaN(itemPrice) || itemPrice < 0) {
                    console.error('Please enter a valid item name and price.');
                    return;
                }

                const newItem = {
                    id: Date.now(),
                    name: itemName,
                    quantity: itemQuantity,
                    price: itemPrice,
                    total: itemQuantity * itemPrice,
                };

                items.push(newItem);
                itemNameInput.value = '';
                itemQuantityInput.value = 1;
                itemPriceInput.value = '';
                renderItemListTable();
                renderBillPreview();
            }

            function handleRemoveItem(id) {
                items = items.filter(item => item.id !== id);
                renderItemListTable();
                renderBillPreview();
            }

            function handleClearAll() {
                items = [];
                restaurantName = 'My Awesome Restaurant';
                address = '123 Main St, Anytown, USA';
                tableNo = '';
                invoiceNumber = '';
                vatNumber = '';
                const now = new Date();
                billDateTime = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                paymentMethod = 'Cash';
                currency = 'USD';
                taxRate = 10;
                billTemplate = 'modern';
                renderApp();
            }

            async function handleGeneratePdf() {
                if (pdfLoading || items.length === 0) return;

                pdfLoading = true;
                generatePdfBtn.disabled = true;
                generatePdfBtn.textContent = 'Generating PDF...';

                const billElement = billPreviewContainer.firstElementChild;
                if (!billElement) {
                    console.error("Bill preview element not found for PDF generation.");
                    pdfLoading = false;
                    generatePdfBtn.disabled = false;
                    generatePdfBtn.textContent = 'Save as PDF';
                    return;
                }

                try {
                    const canvas = await html2canvas(billElement, { scale: 2 });
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'px',
                        format: [canvas.width, canvas.height]
                    });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`bill-${invoiceNumber || 'preview'}.pdf`);
                } catch (error) {
                    console.error("Error generating PDF:", error);
                } finally {
                    pdfLoading = false;
                    generatePdfBtn.disabled = false;
                    generatePdfBtn.textContent = 'Save as PDF';
                }
            }

            // --- Initial Render ---
            renderApp();
        });
    </script>
</body>
</html>
